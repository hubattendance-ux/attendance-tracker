<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Attendance Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f3f6fb;--card:#fff;--text:#0b1b2b;--muted:#98a2b3;--accent:#0b7cff;--present:#10b981;--absent:#ff5c6c}
  body[data-theme="dark"]{--bg:#071019;--card:#0b1220;--text:#e6eef6;--muted:#9fb6d9;--accent:#0ad5a8}
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:Inter,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
  .app{min-height:100vh;display:flex;flex-direction:column}
  .card{flex:1;background:var(--card);padding:16px;max-width:800px;margin:0 auto;width:100%}
  header{display:flex;justify-content:space-between;padding-bottom:16px;border-bottom:1px solid rgba(0,0,0,0.06);margin-bottom:20px}
  h1{font-size:20px;font-weight:800}
  .hdr-sub{font-size:13px;color:var(--muted);margin-top:6px}
  .theme-toggle{width:40px;height:40px;border-radius:10px;border:1px solid rgba(11,124,255,0.12);background:transparent;cursor:pointer;font-size:18px}
  label{display:block;font-size:13px;font-weight:600;margin-top:16px;margin-bottom:8px}
  input,select,textarea{width:100%;padding:14px;border-radius:10px;border:1px solid rgba(2,6,23,0.06);background:var(--bg);color:var(--text);font-size:16px;font-family:inherit}
  input:focus,select:focus{outline:none;border-color:var(--accent)}
  .btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:14px 20px;border-radius:12px;background:var(--accent);color:#fff;border:0;font-weight:700;font-size:15px;cursor:pointer;width:100%;font-family:inherit}
  .btn:active{opacity:0.8}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,124,255,0.12)}
  .btn.small{padding:10px 14px;font-size:13px;width:auto}
  .btn.success{background:var(--present)}
  .btn.danger{background:var(--absent)}
  .btn-group{display:flex;gap:10px;margin-top:16px}
  .muted{color:var(--muted);font-size:13px}
  .section{margin-top:24px}
  .section h3{margin:0 0 12px 0;font-size:16px;font-weight:700}
  .student-item,.record-card,.mark-row{padding:14px;border-radius:10px;background:var(--bg);margin-bottom:10px;border:1px solid rgba(2,6,23,0.04)}
  .student-item{display:flex;justify-content:space-between;align-items:center}
  .student-left{font-weight:700;font-size:15px}
  .student-name{color:var(--muted);font-size:13px;margin-top:4px}
  .mark-row{display:flex;justify-content:space-between;align-items:center}
  .toggle-btn{min-width:90px;height:40px;border-radius:10px;border:0;font-weight:700;font-size:14px;cursor:pointer;color:#fff}
  .toggle-absent{background:var(--absent)}
  .toggle-present{background:var(--present)}
  .popup-bg{position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px}
  .popup{background:#071017;color:#7fffd4;padding:16px 24px;border-radius:12px;font-family:'Courier New',monospace}
  .spinner{width:16px;height:16px;border-radius:50%;border:3px solid rgba(255,255,255,0.24);border-top-color:#fff;animation:spin 0.8s linear infinite;margin-right:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .info-box{background:#eaf7ff;padding:12px;border-radius:10px;border-left:4px solid var(--accent);margin-bottom:16px;font-size:13px}
  .student-edit-row{display:flex;gap:8px;margin-bottom:10px;align-items:center}
  .student-edit-row input{flex:1;padding:12px;margin:0}
  .record-date{font-weight:700;font-size:14px;margin-bottom:6px}
  .record-info{color:var(--muted);font-size:13px;margin-bottom:8px}
  .record-status{display:inline-block;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:700}
  .status-present{background:rgba(16,185,129,0.1);color:var(--present)}
  .status-absent{background:rgba(255,92,108,0.1);color:var(--absent)}
  .status-result-card{padding:16px;border-radius:12px;background:var(--bg);margin-bottom:12px;border:1px solid rgba(2,6,23,0.04)}
  .status-subject{font-weight:700;font-size:15px;color:var(--accent);margin-bottom:12px}
  .status-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
  .stat-box{text-align:center;padding:10px;background:var(--card);border-radius:8px}
  .stat-label{font-size:11px;color:var(--muted);margin-bottom:4px}
  .stat-value{font-weight:700;font-size:18px}
  .progress-bar{width:100%;height:8px;background:rgba(2,6,23,0.06);border-radius:4px;overflow:hidden;margin-top:6px}
  .progress-fill{height:100%;transition:width 0.5s ease;border-radius:4px}
  .progress-info{display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px}
  .account-picker-card{padding:12px;background:#f6faff;border-radius:10px;margin-bottom:10px;border:1px solid rgba(11,124,255,0.1)}
  .account-title{font-weight:700;font-size:14px;margin-bottom:4px}
  .account-info{color:var(--muted);font-size:12px;margin-bottom:10px}
  .modal-content{background:var(--card);padding:20px;border-radius:16px;max-width:90%;max-height:80vh;overflow-y:auto}
</style>
</head>
<body>
  <div class="app">
    <div class="card" id="mainCard">
      <header>
        <div class="hdr-left">
          <h1 id="title">Dashboard</h1>
          <div class="hdr-sub" id="hdrInfo">Dept ¬∑ Sem ¬∑ Subject</div>
          <div id="totalClasses" class="muted" style="margin-top:6px;display:none">Total classes: 0</div>
        </div>
        <button id="themeBtn" class="theme-toggle">‚òÄÔ∏è</button>
      </header>

      <div id="views">
        <!-- LOGIN -->
        <div id="loginView">
          <label>Email</label>
          <input id="liEmail" type="email" placeholder="you@gmail.com">
          <label>Password</label>
          <input id="liPass" type="password" placeholder="Password">
          <div class="btn-group">
            <button id="btnLogin" class="btn">Login</button>
          </div>
          <div class="btn-group">
            <button id="btnShowSignup" class="btn ghost">Sign Up</button>
            <button id="btnShowStatus" class="btn success">üßæ Student Status</button>
          </div>
          <div style="margin-top:12px;text-align:center">
            <a href="#" id="lnkForgot" class="muted" style="text-decoration:underline">Forgot Password?</a>
          </div>
        </div>

        <!-- SIGNUP -->
        <div id="signupView" style="display:none">
          <div class="info-box">
            <strong>Create Account:</strong> Fill in all details to create your attendance tracker account.
          </div>
          <label>Email</label>
          <input id="suEmail" type="email" placeholder="you@gmail.com">
          
          <div style="display:flex;gap:10px;margin-top:6px">
            <div style="flex:1">
              <label>Department</label>
              <select id="suDept">
                <option>CSE</option>
                <option>Civil</option>
                <option>Electrical</option>
              </select>
            </div>
            <div style="flex:1">
              <label>Semester</label>
              <select id="suSem">
                <option>1st</option>
                <option>2nd</option>
                <option>3rd</option>
                <option>4th</option>
                <option>5th</option>
                <option>6th</option>
              </select>
            </div>
          </div>

          <label>Subject</label>
          <input id="suSubject" type="text" placeholder="e.g. Physics">
          
          <label>Create Password</label>
          <input id="suPass" type="password" placeholder="Create password">
          
          <label>Confirm Password</label>
          <input id="suConfirm" type="password" placeholder="Confirm password">

          <div class="btn-group">
            <button id="btnSignup" class="btn">Sign Up Now</button>
          </div>
          <div class="btn-group">
            <button id="btnBackToLogin" class="btn ghost">Back to Login</button>
          </div>
        </div>

        <!-- FORGOT PASSWORD -->
        <div id="forgotView" style="display:none">
          <label>Enter your email</label>
          <input id="fpEmail" type="email" placeholder="you@gmail.com">
          
          <div class="btn-group">
            <button id="btnSendToken" class="btn">Send Reset Token</button>
          </div>
          <div class="btn-group">
            <button id="btnBackFromForgot" class="btn ghost">Back to Login</button>
          </div>

          <div id="forgotAccounts" style="margin-top:16px"></div>

          <div id="forgotStep2" style="display:none;margin-top:16px">
            <label>Account</label>
            <select id="fpAccount"></select>
            
            <label>Token</label>
            <input id="fpToken" type="text" placeholder="Enter 6-digit token">
            
            <label>New Password</label>
            <input id="fpNew" type="password" placeholder="Enter new password">

            <div class="btn-group">
              <button id="btnReset" class="btn">Reset Password</button>
            </div>
            <div class="btn-group">
              <button id="btnForgotCancel" class="btn ghost">Cancel</button>
            </div>
          </div>
        </div>

        <!-- STUDENT STATUS -->
        <div id="studentStatusView" style="display:none">
          <div class="info-box" style="background:#e0f7fa;border-left-color:#00acc1">
            <strong>üìä Student Portal:</strong> Check your attendance status.
          </div>

          <label>Department</label>
          <select id="statusDept">
            <option value="">Select Department</option>
            <option>CSE</option>
            <option>Civil</option>
            <option>Electrical</option>
          </select>

          <label>Semester</label>
          <select id="statusSem">
            <option value="">Select Semester</option>
            <option>1st</option>
            <option>2nd</option>
            <option>3rd</option>
            <option>4th</option>
            <option>5th</option>
            <option>6th</option>
          </select>

          <label>Enrollment Number</label>
          <input id="statusEnroll" type="text" placeholder="Enter enrollment number">

          <div class="btn-group">
            <button id="btnCheckStatus" class="btn success">üßæ Check Status</button>
          </div>
          <div class="btn-group">
            <button id="btnBackToLoginFromStatus" class="btn ghost">Back to Login</button>
          </div>

          <div id="statusResults" style="display:none;margin-top:20px">
            <h3>üìà Attendance Summary</h3>
            <div id="statusResultsContent"></div>
          </div>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboardView" style="display:none">
          <div class="section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <h3 style="margin:0">Students</h3>
              <button id="btnEditStudents" class="btn small">Edit Students</button>
            </div>
            
            <div class="students" id="studentsList">
              <div class="muted">No students yet</div>
            </div>

            <div id="studentsEditor" style="display:none;margin-top:16px">
              <div id="studentsEditorRows"></div>
              <div class="btn-group">
                <button id="btnAddStudent" class="btn small">+ Add</button>
                <button id="btnSaveStudents" class="btn small success">Save</button>
                <button id="btnCloseStudents" class="btn small ghost">Cancel</button>
              </div>
            </div>
          </div>

          <div class="section">
            <h3>Mark Attendance</h3>
            <div class="muted" style="margin-bottom:12px">Tap student to toggle Present/Absent</div>

            <div style="display:flex;gap:10px;align-items:center;margin-top:12px">
              <label style="margin:0">Date:</label>
              <input id="quickDate" type="date" style="flex:1">
            </div>
            <div class="btn-group">
              <button id="markBtn" class="btn">Start Marking</button>
            </div>

            <div id="markArea" style="display:none">
              <div style="margin:16px 0 12px 0">
                <div class="muted" style="font-weight:600">Marking List</div>
              </div>

              <div id="markList"></div>

              <div class="btn-group">
                <button id="btnSaveAttendance" class="btn success">Save Attendance</button>
              </div>
              <div class="btn-group">
                <button id="btnCancelMark" class="btn ghost">Cancel</button>
              </div>
            </div>
          </div>

          <div class="section">
            <h3>Search Records</h3>
            <div style="display:flex;gap:10px;margin-top:12px">
              <input id="searchEnroll" placeholder="Enrollment" style="flex:1">
              <select id="filterStatus" style="flex:1">
                <option>All</option>
                <option>Present</option>
                <option>Absent</option>
              </select>
            </div>
            <div class="btn-group">
              <button id="btnSearch" class="btn small">Search</button>
            </div>

            <div id="recordsArea" style="margin-top:12px"></div>
          </div>

          <div style="margin-top:24px">
            <button id="btnLogout" class="btn ghost">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="popupContainer" style="display:none"></div>

<script>
const API_URL = 'api.php'; // Update this to your API URL

const $ = id => document.getElementById(id);

// API Helper
async function apiCall(action, data = {}) {
  const formData = new FormData();
  formData.append('action', action);
  
  for (let key in data) {
    if (typeof data[key] === 'object') {
      formData.append(key, JSON.stringify(data[key]));
    } else {
      formData.append(key, data[key]);
    }
  }
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      body: formData
    });
    return await response.json();
  } catch (error) {
    console.error('API Error:', error);
    return { success: false, message: 'Network error' };
  }
}

// Theme
const THEME_KEY = 'att_theme';
function applyTheme(theme) {
  if (theme === 'dark') {
    document.body.setAttribute('data-theme', 'dark');
    $('themeBtn').textContent = 'üåô';
  } else {
    document.body.removeAttribute('data-theme');
    $('themeBtn').textContent = '‚òÄÔ∏è';
  }
  localStorage.setItem(THEME_KEY, theme);
}

(function initTheme() {
  const saved = localStorage.getItem(THEME_KEY) || 'light';
  applyTheme(saved);
})();

// Helpers
function hackerPopup(msg, timeout = 1800) {
  const c = $('popupContainer');
  c.innerHTML = `<div class="popup-bg"><div class="popup">${msg}</div></div>`;
  c.style.display = 'block';
  setTimeout(() => {
    c.style.display = 'none';
    c.innerHTML = '';
  }, timeout);
}

function setBtnLoading(btn, loading, text) {
  if (!btn) return;
  if (loading) {
    btn._orig = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner"></span>${text || 'Processing...'}`;
  } else {
    btn.disabled = false;
    if (btn._orig) btn.innerHTML = btn._orig;
  }
}

function escapeHtml(s) {
  return String(s || '').replace(/[&<>"']/g, c => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  }[c]));
}

// View management
function show(view) {
  ['login', 'signup', 'forgot', 'studentStatus', 'dashboard'].forEach(v => {
    const el = $(v + 'View');
    if (el) el.style.display = (v === view) ? 'block' : 'none';
  });
  
  $('title').innerText = view === 'dashboard' ? 'Dashboard' :
    view === 'signup' ? 'Sign Up' :
    view === 'forgot' ? 'Forgot Password' :
    view === 'studentStatus' ? 'Student Status' : 'Attendance Login';
  
  const tc = $('totalClasses');
  if (tc) tc.style.display = (view === 'dashboard') ? 'block' : 'none';
}

// SIGNUP
async function doSignup() {
  const btn = $('btnSignup');
  setBtnLoading(btn, true, 'Signing up...');
  
  const email = $('suEmail').value.trim().toLowerCase();
  const department = $('suDept').value;
  const semester = $('suSem').value;
  const subject = $('suSubject').value.trim();
  const password = $('suPass').value;
  const confirm = $('suConfirm').value;
  
  if (!email || !subject || !password || password !== confirm) {
    hackerPopup('Fill all fields & match passwords');
    setBtnLoading(btn, false);
    return;
  }
  
  const res = await apiCall('signup', { email, department, semester, subject, password });
  setBtnLoading(btn, false);
  
  if (res && res.success) {
    hackerPopup('‚úÖ Account created');
    show('login');
  } else {
    hackerPopup(res && res.message ? res.message : 'Signup failed');
  }
}

// LOGIN
async function doLogin() {
  const btn = $('btnLogin');
  setBtnLoading(btn, true, 'Logging in...');
  
  const email = $('liEmail').value.trim().toLowerCase();
  const password = $('liPass').value;
  
  if (!email || !password) {
    hackerPopup('Email and password required');
    setBtnLoading(btn, false);
    return;
  }
  
  const res = await apiCall('login', { email, password });
  setBtnLoading(btn, false);
  
  if (res && res.success) {
    const accs = res.accounts || [];
    if (accs.length === 1) {
      selectAccount(accs[0]);
    } else {
      showAccountPicker(accs);
    }
  } else {
    hackerPopup(res && res.message ? res.message : 'Invalid credentials');
  }
}

// Account Picker
function showAccountPicker(accounts) {
  if (!accounts || accounts.length === 0) return hackerPopup('No accounts found');
  
  const html = accounts.map((a, idx) => `
    <div class="account-picker-card">
      <div class="account-title">${escapeHtml(a.subject || '(no subject)')}</div>
      <div class="account-info">${escapeHtml(a.dept)} ¬∑ ${escapeHtml(a.semester)}</div>
      <button class="btn small" onclick="pickAccount(${idx})">Open</button>
    </div>
  `).join('');
  
  const pc = $('popupContainer');
  pc.innerHTML = `
    <div class="popup-bg">
      <div class="modal-content">
        <h3 style="margin-bottom:12px">Select Account</h3>
        ${html}
        <button class="btn ghost" onclick="closePopup()">Cancel</button>
      </div>
    </div>
  `;
  pc.style.display = 'block';
  window._loginAccounts = accounts;
}

function pickAccount(idx) {
  const arr = window._loginAccounts || [];
  const a = arr[idx];
  closePopup();
  if (a) selectAccount(a);
}

function closePopup() {
  const pc = $('popupContainer');
  pc.style.display = 'none';
  pc.innerHTML = '';
  window._loginAccounts = null;
}

async function selectAccount(acc) {
  currentAccount = acc;
  $('hdrInfo').innerText = (acc.dept || '') + ' ¬∑ ' + (acc.semester || '') + ' ¬∑ ' + (acc.subject || '');
  show('dashboard');
  await loadStudents();
  await loadRecords();
  await updateTotalClasses();
  
  const isFirst = await apiCall('isFirstLogin', { accountId: currentAccount.accountId });
  if (isFirst) openStudentsEditor();
  
  hackerPopup('Login Successful');
}

// FORGOT PASSWORD
async function startForgot() {
  const btn = $('btnSendToken');
  setBtnLoading(btn, true, 'Sending...');
  const email = $('fpEmail').value.trim().toLowerCase();
  
  if (!email) {
    hackerPopup('Enter email');
    setBtnLoading(btn, false);
    return;
  }
  
  const accs = await apiCall('getAccountsByEmail', { email });
  setBtnLoading(btn, false);
  
  const holder = $('forgotAccounts');
  if (!accs || accs.length === 0) {
    holder.innerHTML = '';
    hackerPopup('No accounts for this email');
    return;
  }
  
  holder.innerHTML = accs.map(a => `
    <div class="account-picker-card">
      <div class="account-title">${escapeHtml(a.subject || '(no subject)')}</div>
      <div class="account-info">${escapeHtml(a.dept)} ¬∑ ${escapeHtml(a.semester)}</div>
      <button class="btn small" onclick="sendTokenFor('${a.accountId}')">Send Token</button>
    </div>
  `).join('');
}

async function sendTokenFor(accountId) {
  const pc = $('popupContainer');
  pc.innerHTML = `<div class="popup-bg"><div class="popup">Sending token...</div></div>`;
  pc.style.display = 'block';
  
  const res = await apiCall('sendResetToken', { accountId });
  pc.style.display = 'none';
  pc.innerHTML = '';
  
  if (res && res.success) {
    hackerPopup('Token sent to email');
    if (res.token) alert('Token (testing): ' + res.token);
    $('fpAccount').innerHTML = `<option value="${accountId}">${accountId.substr(0, 8)}</option>`;
    $('forgotStep2').style.display = 'block';
  } else {
    hackerPopup(res && res.message ? res.message : 'Failed to send token');
  }
}

async function doReset() {
  const btn = $('btnReset');
  setBtnLoading(btn, true, 'Resetting...');
  
  const accountId = $('fpAccount').value;
  const token = $('fpToken').value.trim();
  const newPassword = $('fpNew').value;
  
  if (!accountId || !token || !newPassword) {
    hackerPopup('Fill all fields');
    setBtnLoading(btn, false);
    return;
  }
  
  const res = await apiCall('resetPassword', { accountId, token, newPassword });
  setBtnLoading(btn, false);
  
  if (res && res.success) {
    hackerPopup('‚úÖ Password Reset');
    show('login');
  } else {
    hackerPopup(res && res.message ? res.message : 'Reset failed');
  }
}

// STUDENT STATUS
async function checkStudentStatus() {
  const btn = $('btnCheckStatus');
  setBtnLoading(btn, true, 'Checking...');
  
  const department = $('statusDept').value;
  const semester = $('statusSem').value;
  const enrollmentNumber = $('statusEnroll').value.trim();
  
  if (!department || !semester || !enrollmentNumber) {
    hackerPopup('Please fill all fields');
    setBtnLoading(btn, false);
    return;
  }
  
  const res = await apiCall('getStudentStatus', { department, semester, enrollmentNumber });
  setBtnLoading(btn, false);
  
  if (res && res.success) {
    renderStudentStatus(res.data);
  } else {
    hackerPopup(res && res.message ? res.message : 'No records found');
    $('statusResults').style.display = 'none';
  }
}

function renderStudentStatus(data) {
  const container = $('statusResultsContent');
  
  if (!data || Object.keys(data).length === 0) {
    container.innerHTML = '<div class="muted">No attendance records found.</div>';
    $('statusResults').style.display = 'block';
    return;
  }
  
  container.innerHTML = Object.entries(data).map(([subject, stats]) => {
    const percentage = stats.total > 0 ? ((stats.present / stats.total) * 100).toFixed(2) : '0.00';
    const barWidth = percentage;
    const isGood = percentage >= 75;
    
    return `
      <div class="status-result-card">
        <div class="status-subject">üìö ${escapeHtml(subject)}</div>
        
        <div class="status-stats">
          <div class="stat-box">
            <div class="stat-label">Total</div>
            <div class="stat-value">${stats.total}</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Present</div>
            <div class="stat-value" style="color:var(--present)">${stats.present}</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Absent</div>
            <div class="stat-value" style="color:var(--absent)">${stats.absent}</div>
          </div>
        </div>
        
        <div class="progress-info">
          <span class="muted">Attendance %</span>
          <span style="color:${isGood ? 'var(--present)' : 'var(--absent)'}; font-weight:700">${percentage}%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width:${barWidth}%;background:${isGood ? 'var(--present)' : 'var(--absent)'}"></div>
        </div>
      </div>
    `;
  }).join('');
  
  $('statusResults').style.display = 'block';
}

// STUDENTS
let currentAccount = null;
let students = [];
let marking = [];

async function loadStudents() {
  if (!currentAccount) return;
  const res = await apiCall('getStudentsByAccount', { accountId: currentAccount.accountId });
  students = res || [];
  renderStudents();
}

function renderStudents() {
  const list = $('studentsList');
  if (!students || students.length === 0) {
    list.innerHTML = '<div class="muted">No students yet. Tap "Edit Students" to add.</div>';
    return;
  }
  list.innerHTML = students.map(s => `
    <div class="student-item">
      <div>
        <div class="student-left">${escapeHtml(s.enroll)}</div>
        <div class="student-name">${escapeHtml(s.name || '')}</div>
      </div>
    </div>
  `).join('');
}

function openStudentsEditor() {
  const rows = $('studentsEditorRows');
  rows.innerHTML = '';
  const items = students.length ? students : [{ enroll: '', name: '' }];
  items.forEach((s, i) => {
    const rowDiv = document.createElement('div');
    rowDiv.className = 'student-edit-row';
    rowDiv.innerHTML = `
      <input id="se_enroll_${i}" placeholder="Enrollment" value="${escapeHtml(s.enroll || '')}" />
      <input id="se_name_${i}" placeholder="Name" value="${escapeHtml(s.name || '')}" />
      <button class="btn small danger" onclick="removeEditorRow(${i})">√ó</button>
    `;
    rows.appendChild(rowDiv);
  });
  $('studentsEditor').style.display = 'block';
}

function addStudentRow() {
  const rows = $('studentsEditorRows');
  const idx = rows.children.length;
  const rowDiv = document.createElement('div');
  rowDiv.className = 'student-edit-row';
  rowDiv.innerHTML = `
    <input id="se_enroll_${idx}" placeholder="Enrollment" />
    <input id="se_name_${idx}" placeholder="Name" />
    <button class="btn small danger" onclick="removeEditorRow(${idx})">√ó</button>
  `;
  rows.appendChild(rowDiv);
}

function removeEditorRow(i) {
  const rows = $('studentsEditorRows');
  if (rows.children[i]) rows.removeChild(rows.children[i]);
}

function closeStudentsEditor() {
  $('studentsEditor').style.display = 'none';
}

async function saveStudents() {
  const btn = $('btnSaveStudents');
  setBtnLoading(btn, true, 'Saving...');
  const rows = $('studentsEditorRows');
  const updated = [];
  
  for (let i = 0; i < rows.children.length; i++) {
    const enrollEl = $(`se_enroll_${i}`);
    const nameEl = $(`se_name_${i}`);
    const enroll = enrollEl ? enrollEl.value.trim() : '';
    const name = nameEl ? nameEl.value.trim() : '';
    if (enroll) updated.push({ enroll, name });
  }
  
  const res = await apiCall('saveStudentsByAccount', {
    accountId: currentAccount.accountId,
    students: updated
  });
  setBtnLoading(btn, false);
  
  if (res && res.success) {
    students = updated;
    hackerPopup('‚úÖ Students saved');
    closeStudentsEditor();
    renderStudents();
  } else {
    hackerPopup(res && res.message ? res.message : 'Failed to save');
  }
}

// ATTENDANCE
async function startMark() {
  const btn = $('markBtn');
  setBtnLoading(btn, true, 'Checking...');
  
  if (!students || students.length === 0) {
    hackerPopup('No students to mark. Add students first.');
    setBtnLoading(btn, false);
    return;
  }
  
  const date = $('quickDate').value || new Date().toISOString().slice(0, 10);
  
  const canSave = await apiCall('canSaveAttendance', {
    accountId: currentAccount.accountId,
    date
  });
  setBtnLoading(btn, false);
  
  if (!canSave) {
    hackerPopup('Attendance already saved for this date');
    return;
  }
  
  marking = students.map(s => ({ enroll: s.enroll, name: s.name || '', status: 'Absent' }));
  renderMarkList();
  $('markArea').style.display = 'block';
}

function renderMarkList() {
  const c = $('markList');
  if (!marking || marking.length === 0) {
    c.innerHTML = '<div class="muted">No students to mark</div>';
    return;
  }
  
  c.innerHTML = marking.map((m, i) => `
    <div class="mark-row">
      <div class="mark-left">
        <div style="font-weight:700;font-size:15px">${escapeHtml(m.enroll)}</div>
        <div class="muted" style="font-size:13px;margin-top:4px">${escapeHtml(m.name || '')}</div>
      </div>
      <button id="tbtn_${i}" class="toggle-btn ${m.status === 'Present' ? 'toggle-present' : 'toggle-absent'}" onclick="toggleMark(${i})">${m.status}</button>
    </div>
  `).join('');
}

function toggleMark(i) {
  if (!marking[i]) return;
  marking[i].status = marking[i].status === 'Absent' ? 'Present' : 'Absent';
  const btn = $('tbtn_' + i);
  if (btn) {
    btn.textContent = marking[i].status;
    btn.className = 'toggle-btn ' + (marking[i].status === 'Present' ? 'toggle-present' : 'toggle-absent');
  }
}

function cancelMark() {
  $('markArea').style.display = 'none';
  marking = [];
}

async function confirmSave() {
  const btn = $('btnSaveAttendance');
  setBtnLoading(btn, true, 'Saving...');
  
  if (!marking || marking.length === 0) {
    hackerPopup('No marking data');
    setBtnLoading(btn, false);
    return;
  }
  
  const payload = {
    date: $('quickDate').value || new Date().toISOString().slice(0, 10),
    students: marking
  };
  
  const res = await apiCall('saveAttendanceByAccount', {
    accountId: currentAccount.accountId,
    payload
  });
  setBtnLoading(btn, false);
  
  if (res && res.success) {
    hackerPopup('‚úÖ Attendance saved');
    cancelMark();
    await loadRecords();
    await updateTotalClasses();
  } else {
    hackerPopup(res && res.message ? res.message : 'Failed to save');
  }
}

// RECORDS
async function loadRecords() {
  const btn = $('btnSearch');
  setBtnLoading(btn, true, 'Loading...');
  const filter = {
    status: $('filterStatus').value,
    search: $('searchEnroll').value.trim()
  };
  
  const res = await apiCall('getAttendanceByAccount', {
    accountId: currentAccount.accountId,
    filter
  });
  setBtnLoading(btn, false);
  renderRecords(res || []);
}

function renderRecords(records) {
  const a = $('recordsArea');
  if (!records || records.length === 0) {
    a.innerHTML = '<div class="muted">No records found</div>';
    return;
  }
  
  a.innerHTML = records.map(r => `
    <div class="record-card">
      <div class="record-date">${escapeHtml(r.Date)}</div>
      <div class="record-info">${escapeHtml(r.Department)} ¬∑ ${escapeHtml(r.Semester)} ¬∑ ${escapeHtml(r.Subject)}</div>
      <div style="margin-top:8px">
        <strong>${escapeHtml(r.Enroll)}</strong> ¬∑ 
        <span class="record-status ${r.Status === 'Present' ? 'status-present' : 'status-absent'}">${escapeHtml(r.Status)}</span>
      </div>
    </div>
  `).join('');
}

async function updateTotalClasses() {
  if (!currentAccount || !currentAccount.accountId) {
    const el = $('totalClasses');
    if (el) el.textContent = 'Total classes: 0';
    return;
  }
  const count = await apiCall('getTotalClasses', { accountId: currentAccount.accountId });
  const el = $('totalClasses');
  if (el) el.textContent = 'Total classes: ' + (Number(count) || 0);
}

function logout() {
  currentAccount = null;
  students = [];
  marking = [];
  show('login');
  hackerPopup('Logged out');
}

// Set today's date
function setTodayDate() {
  const dateInput = $('quickDate');
  if (dateInput) {
    const today = new Date().toISOString().split('T')[0];
    dateInput.value = today;
  }
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
  setTodayDate();
  show('login');
  
  $('themeBtn').addEventListener('click', () => {
    const cur = localStorage.getItem(THEME_KEY) || 'light';
    applyTheme(cur === 'light' ? 'dark' : 'light');
  });
  
  // Auth
  $('btnSignup').addEventListener('click', doSignup);
  $('btnBackToLogin').addEventListener('click', () => show('login'));
  $('btnSendToken').addEventListener('click', startForgot);
  $('btnBackFromForgot').addEventListener('click', () => show('login'));
  $('btnReset').addEventListener('click', doReset);
  $('btnForgotCancel').addEventListener('click', () => show('login'));
  $('btnLogin').addEventListener('click', doLogin);
  $('btnShowSignup').addEventListener('click', () => show('signup'));
  $('btnShowStatus').addEventListener('click', () => show('studentStatus'));
  $('lnkForgot').addEventListener('click', (e) => { e.preventDefault(); show('forgot'); });
  
  // Student Status
  $('btnBackToLoginFromStatus').addEventListener('click', () => show('login'));
  $('btnCheckStatus').addEventListener('click', checkStudentStatus);
  
  // Students
  $('btnEditStudents').addEventListener('click', openStudentsEditor);
  $('btnAddStudent').addEventListener('click', addStudentRow);
  $('btnSaveStudents').addEventListener('click', saveStudents);
  $('btnCloseStudents').addEventListener('click', closeStudentsEditor);
  
  // Attendance
  $('markBtn').addEventListener('click', startMark);
  $('btnSaveAttendance').addEventListener('click', confirmSave);
  $('btnCancelMark').addEventListener('click', cancelMark);
  
  // Search & Logout
  $('btnSearch').addEventListener('click', loadRecords);
  $('btnLogout').addEventListener('click', logout);
  
  // Enter key for login
  $('liPass').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
});
</script>
</body>
</html>